import torch
from fast_forward import Mode
from general_dense_indexers.dense_index_one_dataset import index_collection
from encoders.nomic import NomicQueryEncoder, NomicDocumentEncoder


def index_nomic_collection(dataset_name, max_id_length, directory, model_name, dim=768):
    """
       Indexes a dataset using the Nomic encoders for both queries and documents with specified parameters.

       Args:
       dataset_name (str): The name of the dataset to index.
       max_id_length (int): Maximum length of the IDs in the dataset.
       directory (str): Directory to store the indexed files.
       model_name (str): Name of the model used for encoding.
       dim (int, optional): Dimension of the embeddings generated by the encoder. Defaults to 768.

       Details:
       Initializes query and document encoders from Nomic and performs indexing with the specified configuration,
       utilizing GPU acceleration if available.
    """
    q_encoder = NomicQueryEncoder("nomic-ai/" + model_name)
    d_encoder = NomicDocumentEncoder(
        "nomic-ai/" + model_name,
        device="cuda:0" if torch.cuda.is_available() else "cpu",
    )
    index_collection(dataset_name, model_name, q_encoder, d_encoder, max_id_length, directory, batch_size=8, dim=dim,
                     mode=Mode.MAXP)


def index_nomic_v1_collection(dataset_name, max_id_length, directory):
    """
      Indexes a dataset using the 'nomic-embed-text-v1' model configuration.

      Args:
      dataset_name (str): The name of the dataset to index.
      max_id_length (int): Maximum length of the IDs in the dataset.
      directory (str): Directory to store the indexed files.
    """
    model_name = "nomic-embed-text-v1"
    index_nomic_collection(dataset_name, max_id_length, directory, model_name)


def main():
    """
       Main function to initiate indexing of the 'irds:msmarco-passage' dataset using the 'nomic-embed-text-v1' model.
    """
    dataset_name = "irds:msmarco-passage"
    max_id_length = 7
    directory = "nomic"
    try:
        index_nomic_v1_collection(dataset_name, max_id_length, directory)

    except Exception as e:
        # Handles any other exceptions
        print(f"An error occurred: {e}")


if __name__ == '__main__':
    main()
